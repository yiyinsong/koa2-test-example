"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var r=e.apply(this,arguments);return new Promise(function(e,t){function n(a,i){try{var u=r[a](i),o=u.value}catch(e){return void t(e)}if(!u.done)return Promise.resolve(o).then(function(e){n("next",e)},function(e){n("throw",e)});e(o)}return n("next")})}}Object.defineProperty(exports,"__esModule",{value:!0});var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_playlist=require("../models/playlist"),_playlist2=_interopRequireDefault(_playlist),_diylist=require("../models/diylist"),_diylist2=_interopRequireDefault(_diylist),_song=require("../models/song"),_song2=_interopRequireDefault(_song),_sequence=require("../models/sequence"),_sequence2=_interopRequireDefault(_sequence),list=function(){var e=_asyncToGenerator(_regenerator2.default.mark(function e(r,t){var n,a,i,u,o;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.request.query,a=n.page&&Number(n.page),i=n.limit&&Number(n.limit),i=i||20,a=a||1,e.next=7,_playlist2.default.find().skip((a-1)*i).limit(i);case 7:return u=e.sent,e.next=10,_playlist2.default.count();case 10:return o=e.sent,u=u||[],e.next=14,r.render("./backend/list",{title:"歌单",data:u,limit:i||20,page:a,total:Math.ceil(o/i)});case 14:case"end":return e.stop()}},e,void 0)}));return function(r,t){return e.apply(this,arguments)}}(),remove=function(){var e=_asyncToGenerator(_regenerator2.default.mark(function e(r,t){var n,a;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.request.query,!(a=n.id)){e.next=6;break}return e.next=5,_playlist2.default.removeOne({id:a});case 5:return e.abrupt("return",r.redirect("/admin/list"));case 6:console.log("删除失败");case 7:case"end":return e.stop()}},e,void 0)}));return function(r,t){return e.apply(this,arguments)}}(),removeMulti=function(){var e=_asyncToGenerator(_regenerator2.default.mark(function e(r,t){var n,a;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.request.query,!(a=n.ids)){e.next=7;break}return a=a.split(","),e.next=6,_playlist2.default.removeMulti("id",a);case 6:return e.abrupt("return",r.redirect("/admin/list"));case 7:console.log("删除失败");case 8:case"end":return e.stop()}},e,void 0)}));return function(r,t){return e.apply(this,arguments)}}(),listDetail=function(){var e=_asyncToGenerator(_regenerator2.default.mark(function e(r,t){var n,a,i,u,o;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.request.query,a=n.id,i=n.oid,!a){e.next=13;break}return e.next=6,_playlist2.default.findById(a);case 6:return u=e.sent,e.next=9,_song2.default.fetch(i);case 9:return o=e.sent,e.next=12,r.render("./backend/list-detail",{title:"歌单详情",data:u||{},list:o||[]});case 12:return e.abrupt("return",e.sent);case 13:console.log("请传入歌单id");case 14:case"end":return e.stop()}},e,void 0)}));return function(r,t){return e.apply(this,arguments)}}(),removeSong=function(){var e=_asyncToGenerator(_regenerator2.default.mark(function e(r,t){var n,a;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.request.query,!(a=n.sid)){e.next=6;break}return e.next=5,_song2.default.removeOne({id:a});case 5:return e.abrupt("return",r.redirect(r.request.header.referer));case 6:console.log("删除失败");case 7:case"end":return e.stop()}},e,void 0)}));return function(r,t){return e.apply(this,arguments)}}(),removeSongMulti=function(){var e=_asyncToGenerator(_regenerator2.default.mark(function e(r,t){var n,a;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.request.query,!(a=n.ids)){e.next=7;break}return a=a.split(","),e.next=6,_song2.default.removeMulti("id",a);case 6:return e.abrupt("return",r.redirect(r.request.header.referer));case 7:console.log("删除失败");case 8:case"end":return e.stop()}},e,void 0)}));return function(r,t){return e.apply(this,arguments)}}(),diyList=function(){var e=_asyncToGenerator(_regenerator2.default.mark(function e(r,t){var n,a,i,u,o;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.request.query,a=n.page&&Number(n.page),i=n.limit&&Number(n.limit),i=i||20,a=a||1,e.prev=5,e.next=8,_diylist2.default.find().skip((a-1)*i).limit(i);case 8:return u=e.sent,e.next=11,_diylist2.default.count();case 11:return o=e.sent,u=u||[],e.next=15,r.render("./backend/diy-list",{title:"自建歌单",data:u,limit:i||20,page:a,total:Math.ceil(o/i)});case 15:e.next=20;break;case 17:e.prev=17,e.t0=e.catch(5),console.log(e.t0);case 20:case"end":return e.stop()}},e,void 0,[[5,17]])}));return function(r,t){return e.apply(this,arguments)}}(),diyListAdd=function(){var e=_asyncToGenerator(_regenerator2.default.mark(function e(r,t){return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.render("./backend/diy-list-add",{title:"新建歌单"});case 2:case"end":return e.stop()}},e,void 0)}));return function(r,t){return e.apply(this,arguments)}}(),diyListAddAction=function(){var e=_asyncToGenerator(_regenerator2.default.mark(function e(r,t){var n,a,i,u;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.request.body.data){e.next=5;break}return e.abrupt("return",r.body="参数错误");case 5:if(n.img&&""!=n.img){e.next=9;break}return e.abrupt("return",r.body="请传入歌单封面");case 9:if(n.title&&""!=n.title){e.next=13;break}return e.abrupt("return",r.body="请传入歌单名称");case 13:if(n.author&&""!=n.author){e.next=17;break}return e.abrupt("return",r.body="请传入歌单作者");case 17:if(n.desc&&""!=n.desc){e.next=19;break}return e.abrupt("return",r.body="请传入歌单描述");case 19:return e.prev=19,e.next=22,_sequence2.default.getSequence("diylistid");case 22:return a=e.sent,n.id=a,i=new _diylist2.default(n),e.next=27,i.save();case 27:return u=e.sent,e.next=30,r.redirect("/admin/diylist");case 30:e.next=35;break;case 32:e.prev=32,e.t0=e.catch(19),console.log(e.t0);case 35:case"end":return e.stop()}},e,void 0,[[19,32]])}));return function(r,t){return e.apply(this,arguments)}}();exports.default={list:list,remove:remove,removeMulti:removeMulti,listDetail:listDetail,removeSong:removeSong,removeSongMulti:removeSongMulti,diyList:diyList,diyListAdd:diyListAdd,diyListAddAction:diyListAddAction};