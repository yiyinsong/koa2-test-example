"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var r=e.apply(this,arguments);return new Promise(function(e,n){function t(a,o){try{var s=r[a](o),u=s.value}catch(e){return void n(e)}if(!s.done)return Promise.resolve(u).then(function(e){t("next",e)},function(e){t("throw",e)});e(u)}return t("next")})}}Object.defineProperty(exports,"__esModule",{value:!0});var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_mongoose=require("mongoose"),_mongoose2=_interopRequireDefault(_mongoose),_config=require("../utils/config"),_config2=_interopRequireDefault(_config),_password=require("../utils/password"),_password2=_interopRequireDefault(_password),_user=require("../models/user"),_user2=_interopRequireDefault(_user),_sequence=require("../models/sequence"),_sequence2=_interopRequireDefault(_sequence),register=function(){var e=_asyncToGenerator(_regenerator2.default.mark(function e(r,n){return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.render("./frontend/sign",{title:"注册",type:0});case 2:case"end":return e.stop()}},e,void 0)}));return function(r,n){return e.apply(this,arguments)}}(),login=function(){var e=_asyncToGenerator(_regenerator2.default.mark(function e(r,n){return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.render("./frontend/sign",{title:"登录",type:1});case 2:case"end":return e.stop()}},e,void 0)}));return function(r,n){return e.apply(this,arguments)}}(),registerHandle=function(){var e=_asyncToGenerator(_regenerator2.default.mark(function e(r,n){var t,a,o,s,u,i,c,f,l;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=r.request.body,a="",t.username&&""!==t.username?t.tel&&""!==t.tel?t.icon&&""!==t.icon?t.password!==t.repassword&&(a="密码与确认密码不一致"):a="参数异常，请传入用户头像":a="参数异常，请传入手机号码":a="参数异常，请传入用户名",""!==a){e.next=39;break}return e.prev=4,e.next=7,_user2.default.findByName(t.username);case 7:return o=e.sent,e.next=10,_user2.default.findByTel(t.tel);case 10:if(s=e.sent,!o){e.next=15;break}r.body="用户名称已存在，请重新填写用户名",e.next=32;break;case 15:if(!s){e.next=19;break}r.body="手机号码已存在，请重新填写手机号码",e.next=32;break;case 19:return e.next=21,_password2.default.encrypt(t.password);case 21:return u=e.sent,e.next=24,_sequence2.default.getSequence("userid");case 24:return i=e.sent,c={_id:i,username:t.username,tel:t.tel,icon:t.icon,password:u},f=new _user2.default(c),e.next=29,f.save();case 29:return l=e.sent,e.next=32,r.redirect("/login");case 32:e.next=37;break;case 34:e.prev=34,e.t0=e.catch(4),console.log(e.t0);case 37:e.next=40;break;case 39:r.body=a;case 40:case"end":return e.stop()}},e,void 0,[[4,34]])}));return function(r,n){return e.apply(this,arguments)}}(),loginHandle=function(){var e=_asyncToGenerator(_regenerator2.default.mark(function e(r,n){var t,a,o,s,u,i;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=r.request.body,a="",t.username&&""!==t.username||(a="参数异常，请传入用户账号"),""!==a){e.next=37;break}return e.prev=4,console.log(_typeof(t.username)),e.next=8,_user2.default.findByName(t.username);case 8:return o=e.sent,e.next=11,_user2.default.findByTel(t.username);case 11:if(s=e.sent,o||s){e.next=14;break}return e.abrupt("return",r.body="账号错误，请重新输入");case 14:if(u="",!o){e.next=21;break}return e.next=18,_user2.default.findPasswordByName(t.username);case 18:u=e.sent,e.next=24;break;case 21:return e.next=23,_user2.default.findPasswordByTel(t.username);case 23:u=e.sent;case 24:return e.next=26,_password2.default.validate(t.password,u);case 26:if(i=e.sent){e.next=29;break}return e.abrupt("return",r.body="密码错误，请重新输入");case 29:r.body="登录成功！",e.next=35;break;case 32:e.prev=32,e.t0=e.catch(4),console.log(e.t0);case 35:e.next=38;break;case 37:r.body=a;case 38:case"end":return e.stop()}},e,void 0,[[4,32]])}));return function(r,n){return e.apply(this,arguments)}}();exports.default={register:register,registerHandle:registerHandle,login:login,loginHandle:loginHandle};