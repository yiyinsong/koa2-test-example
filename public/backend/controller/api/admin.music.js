"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){function n(a,u){try{var i=t[a](u),o=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(o).then(function(e){n("next",e)},function(e){n("throw",e)});e(o)}return n("next")})}}Object.defineProperty(exports,"__esModule",{value:!0});var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_superagent=require("superagent"),_superagent2=_interopRequireDefault(_superagent),_cheerio=require("cheerio"),_cheerio2=_interopRequireDefault(_cheerio),_playlist=require("../../models/playlist"),_playlist2=_interopRequireDefault(_playlist),task_get_music=function(){var e=_asyncToGenerator(_regenerator2.default.mark(function e(t,r,n,a){var u,i;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,_superagent2.default.get(r+"&limit="+n+"&offset="+n*a);case 2:if(u=e.sent,(i=_cheerio2.default.load(u.text,{decodeEntities:!1}))("#m-pl-container li").each(function(e,r){t.push({id:i(r).find(".icon-play").data("res-id"),img:i(r).find(".j-flag").eq(0).attr("src"),title:i(r).find(".dec a").html(),playNum:i(r).find(".bottom .nb").html(),author:i(r).find(".nm-icn").html()})}),i("#m-pl-container li").length!=n){e.next=11;break}return e.next=8,task_get_music(t,r,n,++a);case 8:return e.abrupt("return",e.sent);case 11:return e.abrupt("return",t);case 12:case"end":return e.stop()}},e,void 0)}));return function(t,r,n,a){return e.apply(this,arguments)}}(),getMuiscListFromWY=function(){var e=_asyncToGenerator(_regenerator2.default.mark(function e(t,r){var n,a,u,i,o;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.request.body.source,a=t.request.body.size,n&&""!==n&&a&&""!==a){e.next=4;break}return e.abrupt("return",t.body={code:0,message:"参数异常",data:{}});case 4:return u=[],e.next=7,task_get_music(u,n,a,0);case 7:return u=e.sent,e.next=10,_playlist2.default.clear();case 10:return i=e.sent,e.next=13,_playlist2.default.collection.insertMany(u);case 13:o=e.sent,t.body={code:1,message:"更新成功",data:u};case 15:case"end":return e.stop()}},e,void 0)}));return function(t,r){return e.apply(this,arguments)}}();exports.default={getMuiscListFromWY:getMuiscListFromWY};